
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>匿名问答 · 调试版</title>
  <style>
    body{font-family:sans-serif;max-width:700px;margin:auto;padding:20px;}
    header{display:flex;justify-content:space-between;align-items:center;}
    nav a,button{padding:6px 12px;background:#0078D4;color:#fff;border:none;border-radius:4px;cursor:pointer;text-decoration:none;}
    .card{padding:12px;margin:12px 0;border:1px solid #ddd;border-radius:6px;}
    section{display:none;}section.active{display:block;}
    textarea,input{width:100%;margin:6px 0;padding:8px;box-sizing:border-box;}
  </style>
</head>
<body>
  <header>
    <h1>匿名问答</h1>
    <nav>
      <a href="#/" id="link-home">首页</a>
      <a href="#/ask" id="link-ask">➕ 发布</a>
    </nav>
  </header>

  <section id="view-list" class="active">
    <div id="list">加载中…</div>
  </section>

  <section id="view-ask">
    <h2>➕ 发布新问题</h2>
    <textarea id="qText" rows="2" placeholder="写下你的问题…"></textarea>
    <input id="o1" placeholder="选项 A">
    <input id="o2" placeholder="选项 B">
    <input id="o3" placeholder="选项 C （可留空）">
    <button id="postBtn">发布问题</button>
  </section>

  <section id="view-poll">
    <div id="pollContent">加载中…</div>
  </section>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // —— 步骤1：使用控制台复制的完整配置 —— 
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
        measurementId: "YOUR_MEASUREMENT_ID"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const pollsCol = db.collection('polls');

      // 路由控制
      function router() {
        const hash = location.hash.split('?')[0];
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        if (hash === '#/ask') {
          document.getElementById('view-ask').classList.add('active');
        } else if (hash === '#/poll') {
          document.getElementById('view-poll').classList.add('active');
          const id = new URLSearchParams(location.hash.split('?')[1]).get('id');
          loadPoll(id);
        } else {
          document.getElementById('view-list').classList.add('active');
          loadList();
        }
      }

      // 加载列表
      function loadList() {
        const list = document.getElementById('list');
        list.textContent = '加载中…';
        pollsCol.orderBy('createdAt','desc').get()
          .then(snap => {
            if (snap.empty) return list.innerHTML = '<p>暂无问题，去发布吧！</p>';
            list.innerHTML = '';
            snap.forEach(doc => {
              const d = doc.data();
              const div = document.createElement('div');
              div.className = 'card';
              div.innerHTML = `<h3>${d.question}</h3><a href="#/poll?id=${doc.id}">去回答 →</a>`;
              list.appendChild(div);
            });
          })
          .catch(err => {
            console.error('加载列表失败：', err);
            list.innerHTML = '<p>加载错误，请刷新重试</p>';
          });
      }

      // 发布事件
      document.getElementById('postBtn').onclick = async () => {
        const question = document.getElementById('qText').value.trim();
        const opts = ['o1','o2','o3']
          .map(id => document.getElementById(id).value.trim())
          .filter(v => v);
        if (!question || opts.length < 2) return alert('请填写问题并至少两个选项');
        try {
          await pollsCol.add({
            question,
            options: opts,
            votes: opts.map(_ => 0),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          location.hash = '#/';
        } catch (err) {
          console.error('发布失败：', err);
          alert('发布失败，请查看控制台');
        }
      };

      // 加载单个投票
      function loadPoll(id) {
        const content = document.getElementById('pollContent');
        if (!id) return content.innerHTML = '<p>无效链接。</p>';
        content.textContent = '加载中…';
        pollsCol.doc(id).onSnapshot(doc => {
          if (!doc.exists) return content.innerHTML = '<p>问题不存在或已删除。</p>';
          const data = doc.data();
          let html = `<h2>${data.question}</h2>`;
          data.options.forEach((opt,i) => {
            html += `<div class="option"><input type="radio" name="vote" value="${i}"> ${opt}</div>`;
          });
          html += `<button id="voteBtn">提交回答</button><div id="results"><h3>当前统计：</h3></div>`;
          content.innerHTML = html;
          const resDiv = document.getElementById('results');
          data.options.forEach((opt,i) => {
            resDiv.innerHTML += `<p class="result">${opt}：${data.votes[i]||0} 次</p>`;
          });
          document.getElementById('voteBtn').onclick = async () => {
            const sel = document.querySelector('input[name="vote"]:checked');
            if (!sel) return alert('请选择一个选项');
            const newVotes = data.votes.slice();
            newVotes[+sel.value] = (newVotes[+sel.value]||0) + 1;
            try {
              await pollsCol.doc(id).update({ votes: newVotes });
            } catch (err) {
              console.error('投票失败：', err);
              alert('投票失败，请重试');
            }
          };
        }, err => {
          console.error('加载问题失败：', err);
          content.innerHTML = '<p>加载失败，请刷新</p>';
        });
      }

      window.addEventListener('hashchange', router);
      router();
    });
  </script>
</body>
</html>
